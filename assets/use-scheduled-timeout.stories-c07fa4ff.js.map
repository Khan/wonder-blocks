{"version":3,"file":"use-scheduled-timeout.stories-c07fa4ff.js","sources":["../../packages/wonder-blocks-timing/src/hooks/use-scheduled-timeout.ts","../../__docs__/wonder-blocks-timing/use-scheduled-timeout.stories.mdx"],"sourcesContent":["import {useEffect, useState, useCallback} from \"react\";\n\nimport {\n    SchedulePolicy as SchedulePolicies,\n    ClearPolicy as ClearPolicies,\n} from \"../util/policies\";\nimport type {ITimeout, ClearPolicy, Options} from \"../util/types\";\n\nimport {useUpdatingRef} from \"./internal/use-updating-ref\";\nimport {useTimeout} from \"./use-timeout\";\n\nexport function useScheduledTimeout(\n    action: () => unknown,\n    timeoutMs: number,\n    options?: Options,\n): ITimeout {\n    if (typeof action !== \"function\") {\n        throw new Error(\"Action must be a function\");\n    }\n\n    if (timeoutMs < 0) {\n        throw new Error(\"Timeout period must be >= 0\");\n    }\n\n    const schedulePolicy =\n        options?.schedulePolicy ?? SchedulePolicies.Immediately;\n\n    const [isSet, setIsSet] = useState(\n        schedulePolicy === SchedulePolicies.Immediately,\n    );\n\n    const set = useCallback(() => setIsSet(true), []);\n\n    // This wrapper isn't present in useScheduledInterval because we\n    // don't need to update `isSet` in that situations.\n    const wrappedAction = useCallback(() => {\n        setIsSet(false);\n        action();\n    }, [action]);\n\n    const actionRef = useUpdatingRef(wrappedAction);\n\n    const clear = useCallback(\n        (policy?: ClearPolicy) => {\n            policy = policy ?? options?.clearPolicy;\n            if (isSet && policy === ClearPolicies.Resolve) {\n                actionRef.current();\n            }\n            setIsSet(false);\n        },\n        // react-hooks/exhaustive-deps doesn't require refs to be\n        // listed in the deps array.  Unfortunately, in this situation\n        // it doesn't recognized actionRef as a ref.\n        [actionRef, isSet, options?.clearPolicy],\n    );\n\n    const runOnUnmountRef = useUpdatingRef(\n        isSet && options?.clearPolicy === ClearPolicies.Resolve,\n    );\n\n    useEffect(() => {\n        return () => {\n            // This code will only run with the component using this\n            // hook is unmounted.\n            // eslint-disable-next-line react-hooks/exhaustive-deps\n            if (runOnUnmountRef.current) {\n                // eslint-disable-next-line react-hooks/exhaustive-deps\n                actionRef.current();\n            }\n        };\n        // This eslint rule doesn't realize actionRef and runOnUnmountRef\n        // a both refs and thus do not have to be listed as deps.\n        // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, []);\n\n    useTimeout(wrappedAction, timeoutMs, isSet);\n\n    return {isSet, set, clear};\n}\n","import {Meta, Story, Source, Canvas} from \"@storybook/blocks\";\n\nimport {Body, HeadingSmall} from \"@khanacademy/wonder-blocks-typography\";\nimport {View} from \"@khanacademy/wonder-blocks-core\";\nimport Button from \"@khanacademy/wonder-blocks-button\";\n\nimport {\n    ClearPolicy,\n    SchedulePolicy,\n} from \"../../packages/wonder-blocks-timing/src/util/policies\";\nimport {useScheduledTimeout} from \"@khanacademy/wonder-blocks-timing\";\n\n<Meta\n    title=\"Timing/useScheduledTimeout\"\n    parameters={{\n        chromatic: {\n            disableSnapshot: true,\n        },\n    }}\n/>\n\n# `useScheduledTimeout`\n\n`useScheduledTimeout` is a hook that provides a convenient API for setting and clearing\na timeout. It is defined as follows:\n\n```ts\nfunction useScheduledTimeout(\n    action: () => mixed,\n    timeoutMs: number,\n    options?: {|\n        schedulePolicy?: \"schedule-immediately\" | \"schedule-on-demand\",\n        clearPolicy?: \"resolve-on-clear\" | \"cancel-on-clear\",\n    |},\n): ITimeout;\n\ninterface ITimeout {\n    get isSet(): boolean;\n    set(): void;\n    clear(policy?: ClearPolicy): void;\n}\n```\n\nBy default the timeout will be set immediately up creation. The `options` parameter can\nbe used to control when when the timeout is schedule and whether or not `action` should be\ncalled when the timeout is cleared.\n\nNotes:\n\n-   Because `clear` takes a param, it's import that you don't pass it directly to an event handler,\n    e.g. `<Button onClick={clear} />` will not work as expected.\n-   Calling `set` after the timeout has expired will restart the timeout.\n-   Updating the second paramter, `timeoutMs`, will also restart the timeout.\n-   When the component using this hooks is unmounted, the timeout will automatically be cleared.\n-   Calling `set` after the timeout is set but before it expires means that the timeout will be\n    reset and will call `action`, `timeoutMs` after the most recent call to `set` was made.\n\nexport const Immediately = () => {\n    const [callCount, setCallCount] = React.useState(0);\n    const callback = React.useCallback(() => {\n        setCallCount((callCount) => callCount + 1);\n    }, []);\n    const {isSet, set, clear} = useScheduledTimeout(callback, 1000);\n    return (\n        <View>\n            <View>isSet = {isSet.toString()}</View>\n            <View>callCount = {callCount}</View>\n            <View style={{flexDirection: \"row\"}}>\n                <Button onClick={set}>Set timeout</Button>\n                <Button onClick={clear}>Clear timeout</Button>\n            </View>\n        </View>\n    );\n};\n\n<Canvas>\n    <Story name=\"Immediately\">\n        <Immediately />\n    </Story>\n</Canvas>\n\n```jsx\nconst Immediately = () => {\n    const [callCount, setCallCount] = React.useState(0);\n    const callback = React.useCallback(() => {\n        setCallCount((callCount) => callCount + 1);\n    }, []);\n    const {isSet, set, clear} = useScheduledTimeout(callback, 1000);\n    return (\n        <View>\n            <View>isSet = {isSet.toString()}</View>\n            <View>callCount = {callCount}</View>\n            <View style={{flexDirection: \"row\"}}>\n                <Button onClick={() => set()}>Set timeout</Button>\n                <Button onClick={() => clear()}>Clear timeout</Button>\n            </View>\n        </View>\n    );\n};\n```\n\nexport const OnDemandAndResolveOnClear = () => {\n    const [callCount, setCallCount] = React.useState(0);\n    const callback = React.useCallback(() => {\n        console.log(\"action called\");\n        setCallCount((callCount) => callCount + 1);\n    }, []);\n    const {isSet, set, clear} = useScheduledTimeout(callback, 1000, {\n        clearPolicy: ClearPolicy.Resolve,\n        schedulePolicy: SchedulePolicy.OnDemand,\n    });\n    return (\n        <View>\n            <View>isSet = {isSet.toString()}</View>\n            <View>callCount = {callCount}</View>\n            <View style={{flexDirection: \"row\"}}>\n                <Button onClick={() => set()}>Set timeout</Button>\n                <Button onClick={() => clear()}>Clear timeout</Button>\n            </View>\n        </View>\n    );\n};\n\n<Canvas>\n    <Story name=\"OnDemandAndResolveOnClear\">\n        <OnDemandAndResolveOnClear />\n    </Story>\n</Canvas>\n\n```jsx\nconst OnDemandAndResolveOnClear = () => {\n    const [callCount, setCallCount] = React.useState(0);\n    const callback = React.useCallback(() => {\n        setCallCount((callCount) => callCount + 1);\n    }, []);\n    const {isSet, set, clear} = useScheduledTimeout(callback, 1000, {\n        clearPolicy: ClearPolicy.Resolve,\n        schedulePolicy: SchedulePolicy.OnDemand,\n    });\n    return (\n        <View>\n            <View>isSet = {isSet.toString()}</View>\n            <View>callCount = {callCount}</View>\n            <View style={{flexDirection: \"row\"}}>\n                <Button onClick={() => set()}>Set timeout</Button>\n                <Button onClick={() => clear()}>Clear timeout</Button>\n            </View>\n        </View>\n    );\n};\n```\n"],"names":["useScheduledTimeout","action","timeoutMs","options","schedulePolicy","SchedulePolicies","isSet","setIsSet","useState","set","useCallback","wrappedAction","actionRef","useUpdatingRef","clear","policy","ClearPolicies","runOnUnmountRef","useEffect","useTimeout","Immediately","callCount","setCallCount","callback","_jsxs","View","_jsx","Button","OnDemandAndResolveOnClear","ClearPolicy","SchedulePolicy","_createMdxContent","props","_components","_provideComponents","_Fragment","Meta","Canvas","Story","MDXContent","MDXLayout","immediately","onDemandAndResolveOnClear","componentMeta","__namedExportsOrder"],"mappings":"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"}