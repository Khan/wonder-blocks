{"version":3,"file":"_overview_testing_.stories-bad23ee8.js","sources":["../../__docs__/wonder-blocks-data/_overview_testing_.stories.mdx"],"sourcesContent":["import {Meta} from \"@storybook/blocks\";\n\n<Meta\n    title=\"Data / Testing\"\n    parameters={{\n        chromatic: {\n            disableSnapshot: true,\n        },\n    }}\n/>\n\n# Testing Support\n\nWonder Blocks Data has been designed to support testing in a variety of environments including jest and storybook. In order to support the various ways in which folks need to test their code, we have considered a number of approaches to testing Wonder Blocks Data.\n\n## Spies\n\nIf you are writing unit tests, you may just want to spy on the methods you are calling using `jest.spyOn` or similar. This can be a really easy way to intercept the request handler passed to the [`useCachedEffect`](/docs/data-exports-usecachedeffect--page) hook, for example, and check that it is the handler you expect.\n\n## Interceptors\n\nEach request used by Wonder Blocks Data has to have an identifier. The [`InterceptRequests`](/docs/data-exports-interceptrequests--page) component allows you to wrap the code under test with an interceptor. Interceptors are given the request identifier and get to choose, based off that identifier, if they want to provide their own response rather than let the original request handler deal with it.\n\nMultiple interceptors can be registered by nesting the [`InterceptRequests`](/docs/data-exports-interceptrequests--page) component as is necessary. Registered interceptors are invoked in ancestral order, with the nearest ancestor to the intercepted request being invoked first.\n\nWhen hooks like [`useServerEffect`](/docs/data-exports-useservereffect--page), [`useCachedEffect`](/docs/data-exports-usecachedeffect--page), or [`useHydratedEffect`](/docs/data-exports-usehydratedeffect--page) run, they get the chain of registered interceptors and chain those with the original handler in order to determine what to actually do when executing the request.\n\nThis allows you to mock out requests in unit tests, stories, and other scenarios.\n\n## GqlRouter, mockGqlFetch, and RespondWith\n\nIf you are testing GraphQL operations, you can configure [`GqlRouter`](/docs/data-exports-gqlrouter--page) with your own function for the `fetch` prop. However, crafting the right response to give\nthe result you want is a bit tricky.\n\n```tsx\nconst myFakeGqlFetch = (\n    operation: GqlOperation<TData, TVariables>,\n    variables: ?TVariables,\n    context: TContext,\n): Promise<Response> {\n    if (operation.id === \"myQuery\" && variables?.someVar === 5) {\n        return Promise.resolve({\n            status: 200,\n            text: () =>\n                Promise.resolve(\n                    JSON.stringify({\n                        data: {\n                            myQuery: {\n                                someField: \"someValue\",\n                            },\n                        },\n                    }),\n                ),\n        });\n    }\n\n    return Promise.resolve({\n        status: 404,\n        text: () => Promise.resolve(JSON.stringify({})),\n    });\n}\n\n<GqlRouter fetch={myFakeGqlFetch} defaultContext={{some: \"sort of context\"}}>\n    <ComponentUnderTest />\n</GqlRouter>\n```\n\nAs shown above, you can interrogate parts of the requested operation to decide how to respond. However, this can get cumbersome if you have GraphQL requests nested in more complex components as each test has to mock out suitable responses for each one. To help with this the Wonder Blocks Testing package provides a [`RespondWith`](/docs/testing-exports-respondwith--page) type for defining responses that fit a specific scenario, and the [`mockGqlFetch()`](/docs/testing-exports-mockgqlfetch--page) API.\n\n```tsx\nconst myFakeGqlFetch = mockGqlFetch().mockOperationOnce(\n    {\n        operation: MyQueryOperation,\n        variables: {\n            someVar: 5,\n        },\n    },\n    RespondWith.success({\n        data: {\n            myQuery: {\n                someField: \"someValue\",\n            },\n        },\n    }),\n);\n\n<GqlRouter fetch={myFakeGqlFetch} defaultContext={{some: \"sort of context\"}}>\n    <ComponentUnderTest />\n</GqlRouter>;\n```\n\nIn the above example, we now only mock our specific operation once. If something\ntries to request this data a second time, it will give an error instead. Not only that, but with a little refactoring, we can create a helper to set this mock up that others can call if they need to mock our operation for their own tests.\n\n```ts\nconst mockMyQuery = (mockGqlFetchFn: GqlFetchMockFn): GqlFetchMockFn =>\n    mockGqlFetchFn().mockOperationOnce(\n        {\n            operation: MyQueryOperation,\n            variables: {\n                someVar: 5,\n            },\n        },\n        RespondWith.success({\n            data: {\n                myQuery: {\n                    someField: \"someValue\",\n                },\n            },\n        }),\n    );\n\nconst myFakeGqlFetch = mockMyQuery(mockGqlFetch());\n\n<GqlRouter fetch={myFakeGqlFetch} defaultContext={{some: \"sort of context\"}}>\n    <ComponentUnderTest />\n</GqlRouter>;\n```\n\nNow, using a compose function, multiple mocks can be setup on the same `mockGqlFetch` instance.\n\nFor more details on this and other testing utilities, see the [Wonder Blocks Testing documentation](/docs/testing-overview--page).\n"],"names":["_createMdxContent","props","_components","_provideComponents","_jsxs","_Fragment","_jsx","Meta","MDXContent","MDXLayout","__page","componentMeta","__namedExportsOrder"],"mappings":"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"}